"use strict";(()=>{var e={};e.id=412,e.ids=[412],e.modules={6517:e=>{e.exports=require("lodash")},9283:e=>{e.exports=require("lodash/at")},770:e=>{e.exports=require("lodash/clone")},9131:e=>{e.exports=require("lodash/compact")},8390:e=>{e.exports=require("lodash/extend")},9368:e=>{e.exports=require("lodash/filter")},2265:e=>{e.exports=require("lodash/first")},1238:e=>{e.exports=require("lodash/includes")},5599:e=>{e.exports=require("lodash/isArray")},9699:e=>{e.exports=require("lodash/isEmpty")},5716:e=>{e.exports=require("lodash/isFunction")},7078:e=>{e.exports=require("lodash/isNumber")},5795:e=>{e.exports=require("lodash/isObject")},5452:e=>{e.exports=require("lodash/isPlainObject")},7026:e=>{e.exports=require("lodash/isString")},2133:e=>{e.exports=require("lodash/isUndefined")},3824:e=>{e.exports=require("lodash/last")},3707:e=>{e.exports=require("lodash/map")},1516:e=>{e.exports=require("lodash/take")},1185:e=>{e.exports=require("mongoose")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},3477:e=>{e.exports=require("querystring")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},8031:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>f,originalPathname:()=>q,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>g});var a={};t.r(a),t.d(a,{GET:()=>GET,POST:()=>POST});var o=t(884),s=t(6132),i=t(5798),l=t(1017),u=t.n(l),p=t(7547),n=t(1296),d=t(9636);async function uploadToCloudinary(e,r,t="image"){try{return new Promise((a,o)=>{let s={resource_type:t,public_id:`templates/${r.split(".")[0]}`,folder:"template-creator",overwrite:!0,timeout:12e4,chunk_size:6e6},i=d.v2.uploader.upload_stream(s,(e,r)=>{e?(console.error("Cloudinary upload error:",e),o(e)):(console.log("Cloudinary upload success:",r?.secure_url),a(r))});i.on("error",e=>{console.error("Upload stream error:",e),o(e)}),i.end(e)})}catch(e){throw console.error("Cloudinary upload error:",e),e}}async function GET(){try{await (0,p.Z)();let e=await n.Z.find({isActive:!0}).sort({createdAt:-1});return i.Z.json(e)}catch(e){return console.error("Error fetching templates:",e),i.Z.json({error:"Failed to fetch templates"},{status:500})}}async function POST(e){try{await (0,p.Z)();let r=await e.formData(),t=r.get("file"),a=r.get("template");if(!a)return i.Z.json({error:"Template data is required"},{status:400});let o=JSON.parse(a),s=o.backgroundImage,l=t&&"application/pdf"===t.type;if(t&&t.size>0){let e;let r=await t.arrayBuffer(),a=Buffer.from(r),o=Date.now(),i=u().extname(t.name),p=`template-${o}${i}`,n=l?"raw":"image",d=3;for(;d>0;)try{e=await Promise.race([uploadToCloudinary(a,p,n),new Promise((e,r)=>setTimeout(()=>r(Error("Upload timeout")),6e4))]);break}catch(e){if(d--,console.error(`Upload attempt failed (${3-d}/3):`,e),0===d)throw Error(`Failed to upload after 3 attempts: ${e.message}`);await new Promise(e=>setTimeout(e,2e3))}s=e.secure_url}let d=new n.Z({name:o.name,description:o.description,category:o.category,backgroundImage:s,width:o.width,height:o.height,placeholders:o.placeholders,isPdf:l,pdfFilePath:l?s:void 0,totalPages:l?o.totalPages||1:void 0,isActive:!0,createdBy:"admin",createdAt:new Date,updatedAt:new Date}),c=await d.save();return i.Z.json(c,{status:201})}catch(r){console.error("Error creating template:",r);let e="Failed to create template";return r.message.includes("Upload timeout")?e="File upload timed out. Please try with a smaller file or check your internet connection.":r.message.includes("ECONNRESET")?e="Connection was reset during upload. Please try again.":r.message.includes("Failed to upload after")&&(e="Multiple upload attempts failed. Please check your file and try again."),i.Z.json({error:e,details:r.message},{status:500})}}d.v2.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});let c=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/templates/route",pathname:"/api/templates",filename:"route",bundlePath:"app/api/templates/route"},resolvedPagePath:"C:\\Users\\prana\\CascadeProjects\\template-creator\\app\\api\\templates\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:x,headerHooks:f,staticGenerationBailout:g}=c,q="/api/templates/route"}};var r=require("../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[997,636,841],()=>__webpack_exec__(8031));module.exports=t})();